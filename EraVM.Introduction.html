<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>EraVM.Introduction</title>

  <script defer=""
  src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" />
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library EraVM.Introduction</h1>

<div class="code">
</div>

<div class="doc"><p>This is the specification of the instruction set of EraVM 1.4.1, a
language virtual machine for zkSync Era. It describes the virtual
machine’s architecture, instruction syntax and semantics, and some
elements of system protocol.</p>
<h1 id="table-of-contents">Table of contents</h1>
<ul>
<li><p><strong>Overview</strong></p>
<ul>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Glossary.html#Glossary"><span
class="id" title="section">Glossary</span></a></span> : a list of all
important recurring terms and notations defined in this document.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Core.html#ArchOverview"><span
class="id" title="section">ArchOverview</span></a></span> : a bird’s eye
overview of EraVM architecture with links to more detailed descriptions
of its parts.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.PrimitiveValue.html#PrimitiveValue"><span
class="id" title="section">PrimitiveValue</span></a></span> : defines a
tagged 256-bit word datatype; can be an integer or a pointer.</li>
</ul></li>
<li><p><strong>EraVM Structure</strong></p>
<p><span
class="inlinecode"><a class="idref" href="EraVM.State.html#StateDefinitions"><span
class="id" title="section">StateDefinitions</span></a></span> collects
all system state, persistent and transient.</p>
<ul>
<li><span
class="inlinecode"><a class="idref" href="EraVM.GPR.html#Registers"><span
class="id" title="section">Registers</span></a></span> : a group of
isolated read/write memory cells available to all instructions.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Flags.html#Flags"><span
class="id" title="section">Flags</span></a></span> : special registers
showing the status of the latest computations.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Predication.html#Predication"><span
class="id" title="section">Predication</span></a></span> : how setting
flags makes EraVM skip of execute instructions.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.memory.PageTypes.html#Memory"><span
class="id" title="section">Memory</span></a></span> : transient memory
(heap, stack) for supporting computations and persistent storages of
contracts.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Pointer.html#PointerDefinitions"><span
class="id" title="section">PointerDefinitions</span></a></span> :
definition of pointers to transient memory and operations on them.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Slice.html#Slices"><span
class="id" title="section">Slices</span></a></span> : how individual
pointers are restricted to selected subranges of memory addresses.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.CallStack.html#Callstack"><span
class="id" title="section">Callstack</span></a></span> : states of
running functions and contracts.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.MemoryContext.html#MemoryContext"><span
class="id" title="section">MemoryContext</span></a></span> : how new
transient memory is allocated when a contract is called.</li>
</ul></li>
<li><p><strong>Instruction Set</strong></p>
<ul>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.Addressing.html#Addressing"><span
class="id" title="section">Addressing</span></a></span> : how
instructions can refer to their arguments.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.Resolution.html#AllResolution.Resolution"><span
class="id" title="section">Resolution</span></a></span> : how
instruction arguments are resolved to the operand values.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.isa.Instructions.html#InstructionSets"><span
class="id" title="section">InstructionSets</span></a></span> : overview
of all layers of instruction set and their relations.</p>
<ul>
<li><span
class="inlinecode"><a class="idref" href="EraVM.isa.Modifiers.html#Modifiers"><span
class="id" title="section">Modifiers</span></a></span> : recurring
modifiers supported by many instructions: <span
class="inlinecode"><a class="idref" href="EraVM.isa.Modifiers.html#mod_set_flags"><span
class="id" title="inductive">mod_set_flags</span></a></span> and <span
class="inlinecode"><a class="idref" href="EraVM.isa.Modifiers.html#mod_swap"><span
class="id" title="inductive">mod_swap</span></a></span>.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.isa.Assembly.html#AssemblyInstructionSet"><span
class="id" title="section">AssemblyInstructionSet</span></a></span> :
<strong>instruction set exposed to assembly programmers</strong>.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.isa.CoreSet.html#CoreInstructionSet"><span
class="id" title="section">CoreInstructionSet</span></a></span> :
simplified instruction set used to define instruction semantic.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.isa.GeneratedMachISA.html#MachInstructionDefinition"><span
class="id" title="section">MachInstructionDefinition</span></a></span> :
layout of encoded assembly instructions.</li>
<li>Conversions between instruction sets: <span class="inlinecode"><span
class="id" title="var">asm_to_core</span></span> and <span
class="inlinecode"><a class="idref" href="EraVM.isa.AssemblyToMach.html#asm_to_mach"><span
class="id" title="definition">asm_to_mach</span></a></span>.</li>
</ul></li>
</ul></li>
<li><p><strong>EraVM operation</strong></p>
<ul>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.Ergs.html#Ergs"><span
class="id" title="section">Ergs</span></a></span> : resource/gas system
and basic operation costs.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.MemoryOps.html#MemoryOps"><span
class="id" title="section">MemoryOps</span></a></span> : precise
formalization of memory writes and reads.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.MemoryManagement.html#MemoryForwarding"><span
class="id" title="section">MemoryForwarding</span></a></span> : a
mechanism to pass memory slices between contracts.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.Event.html#Events"><span
class="id" title="section">Events</span></a></span> : different types of
events emitted when EraVM is operating.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#KernelMode"><span
class="id" title="section">KernelMode</span></a></span> : privileged
mode of execution for system contracts allowing a restricted part of the
instructions set.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.StaticMode.html#StaticMode"><span
class="id" title="section">StaticMode</span></a></span> : mode of
execution with limited effects on persistent state.</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.Semantics.html#SmallStep"><span
class="id" title="section">SmallStep</span></a></span> : formal
semantics of instruction execution cycle, in small-step operational
style</p></li>
<li><p><span
class="inlinecode"><a class="idref" href="EraVM.VMPanic.html#Panics"><span
class="id" title="section">Panics</span></a></span> : a mechanism of
signaling irrecoverable errors and a list of situations where they
occur.</p></li>
</ul></li>
<li><p><strong>Instruction set semantic</strong></p>
<ul>
<li><p>Stack manipulation</p>
<ul>
<li><strong><code>SpAdd</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.SpAdd.html#SpAddDefinition"><span
class="id" title="section">SpAddDefinition</span></a></span> : forward
stack pointer.</li>
<li><strong><code>SpSub</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.SpSub.html#SpSubDefinition"><span
class="id" title="section">SpSubDefinition</span></a></span> : rewind
stack pointer.</li>
</ul></li>
<li><p>Arithmetic</p>
<ul>
<li><strong><code>Add</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Add.html#AddDefinition"><span
class="id" title="section">AddDefinition</span></a></span> :</li>
<li><strong><code>Sub</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Sub.html#SubDefinition"><span
class="id" title="section">SubDefinition</span></a></span> :</li>
<li><strong><code>Mul</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Mul.html#MulDefinition"><span
class="id" title="section">MulDefinition</span></a></span> :</li>
<li><strong><code>Div</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Div.html#DivDefinition"><span
class="id" title="section">DivDefinition</span></a></span> :</li>
</ul></li>
<li><p>Bitwise logical</p>
<ul>
<li><strong><code>And</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.And.html#AndDefinition"><span
class="id" title="section">AndDefinition</span></a></span> :</li>
<li><strong><code>Or</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Or.html#OrDefinition"><span
class="id" title="section">OrDefinition</span></a></span> :</li>
<li><strong><code>Xor</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Xor.html#XorDefinition"><span
class="id" title="section">XorDefinition</span></a></span> :</li>
</ul></li>
<li><p>Bitwise shifts</p>
<ul>
<li><strong><code>Shl</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Shl.html#ShlDefinition"><span
class="id" title="section">ShlDefinition</span></a></span> : left
logical shift.</li>
<li><strong><code>Shr</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Shr.html#ShrDefinition"><span
class="id" title="section">ShrDefinition</span></a></span> : right
logical shift.</li>
<li><strong><code>Rol</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Rol.html#RolDefinition"><span
class="id" title="section">RolDefinition</span></a></span> : left
circular shift.</li>
<li><strong><code>Ror</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Ror.html#RorDefinition"><span
class="id" title="section">RorDefinition</span></a></span> : right
circular shift.</li>
</ul></li>
<li><p>Control flow</p>
<ul>
<li><p><strong><code>Nop</code></strong> : <span
class="inlinecode"><span class="id"
title="var">NopDefinition</span></span> : do nothing.</p></li>
<li><p><strong><code>Jump</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Jump.html#JumpDefinition"><span
class="id" title="section">JumpDefinition</span></a></span> : jump to
code (conditional jumps are implemented through <span
class="inlinecode"><a class="idref" href="EraVM.Predication.html#Predication"><span
class="id" title="section">Predication</span></a></span>).</p></li>
<li><p><strong><code>NearCall</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.NearCall.html#NearCallDefinition"><span
class="id" title="section">NearCallDefinition</span></a></span> : call a
function in the same contract.</p></li>
<li><p><strong><code>NearRet</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.NearRet.html#NearRetDefinition"><span
class="id" title="section">NearRetDefinition</span></a></span> : normal
return from near call to the call site, return unspend ergs.</p></li>
<li><p><strong><code>NearRevert</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.NearRevert.html#NearRevertDefinition"><span
class="id" title="section">NearRevertDefinition</span></a></span> :
return from near call due to a recoverable error, return unspend ergs,
roll back storage/events, execute exception handler.</p></li>
<li><p><strong><code>NearRetTo</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.NearRetTo.html#NearRetToDefinition"><span
class="id" title="section">NearRetToDefinition</span></a></span> : Like
<code>NearRet</code> but returns to explicit label.</p></li>
<li><p><strong><code>NearRevertTo</code></strong> : <span
class="inlinecode"><span class="id"
title="var">NearRevertToDefinition</span></span> : like
<code>NearRevert</code> but executes code at label instead of exception
handler.</p></li>
<li><p><strong><code>Panic</code></strong> : <span
class="inlinecode"><span class="id"
title="var">PanicDefinition</span></span> : trigger panic.</p></li>
<li><p><strong><code>NearPanicTo</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.NearPanicTo.html#NearPanicToDefinition"><span
class="id" title="section">NearPanicToDefinition</span></a></span> :
trigger panic and return to label.</p></li>
<li><p><strong><code>Farcall</code></strong> : <span
class="inlinecode"><span class="id"
title="var">FarcallDefinition</span></span> : call a contract</p></li>
<li><p><strong><code>FarRet</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.FarRet.html#FarRetDefinition"><span
class="id" title="section">FarRetDefinition</span></a></span> : return
from farcall.</p></li>
<li><p><strong><code>FarRevert</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.FarRevert.html#FarRevertDefinition"><span
class="id" title="section">FarRevertDefinition</span></a></span> : like
<code>FarRet</code> but roll back storage/events and execute exception
handler.</p></li>
</ul></li>
<li><p>Operations with heaps</p>
<ul>
<li><strong><code>LoadPtr</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.LoadPtr.html#LoadPtrDefinition"><span
class="id" title="section">LoadPtrDefinition</span></a></span> : load
word by a fat pointer.</li>
<li><strong><code>LoadPtrInc</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.LoadPtrInc.html#LoadPtrIncDefinition"><span
class="id" title="section">LoadPtrIncDefinition</span></a></span> : like
<code>LoadPtr</code>, additionally return an incremented pointer.</li>
<li><strong><code>Load</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Load.html#LoadDefinition"><span
class="id" title="section">LoadDefinition</span></a></span> : load word
from heap by a fat pointer.</li>
<li><strong><code>LoadInc</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.LoadInc.html#LoadIncDefinition"><span
class="id" title="section">LoadIncDefinition</span></a></span> : like
<code>Load</code>, additionally return offset+32.</li>
<li><strong><code>Store</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.Store.html#StoreDefinition"><span
class="id" title="section">StoreDefinition</span></a></span> : store
word to heap by an offset.</li>
<li><strong><code>StoreInc</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.StoreInc.html#StoreIncDefinition"><span
class="id" title="section">StoreIncDefinition</span></a></span> : like
<code>Store</code>, additionally return offset+32.</li>
</ul></li>
<li><p>Operations with pointers</p>
<ul>
<li><strong><code>PtrAdd</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.PtrAdd.html#PtrAddDefinition"><span
class="id" title="section">PtrAddDefinition</span></a></span> :
increment pointer.</li>
<li><strong><code>PtrSub</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.PtrSub.html#PtrSubDefinition"><span
class="id" title="section">PtrSubDefinition</span></a></span> :
decrement pointer.</li>
<li><strong><code>PtrShrink</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.PtrShrink.html#PtrShrinkDefinition"><span
class="id" title="section">PtrShrinkDefinition</span></a></span> :
restrict the range of addresses that a pointer can reference.</li>
<li><strong><code>PtrPack</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.PtrPack.html#PtrPackDefinition"><span
class="id" title="section">PtrPackDefinition</span></a></span> : put
data in the unused high 128 bits of a pointer.</li>
</ul></li>
<li><p>Operations with storage</p>
<ul>
<li><strong><code>SStore</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.SStore.html#SStoreDefinition"><span
class="id" title="section">SStoreDefinition</span></a></span> : store
value at a key in storage of the current contract.</li>
<li><strong><code>SLoad</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.SLoad.html#SLoadDefinition"><span
class="id" title="section">SLoadDefinition</span></a></span> : load
value by key from storage of the current contract.</li>
</ul></li>
<li><p>Events and precompiles</p>
<ul>
<li><p><strong><code>OpEvent</code></strong> : <span
class="inlinecode"><span class="id"
title="var">OpEventDefinition</span></span> : emit an event.</p></li>
<li><p><strong><code>ToL1</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.ToL1.html#ToL1Definition"><span
class="id" title="section">ToL1Definition</span></a></span> : emit a
message to L1.</p></li>
<li><p><strong><code>PrecompileCall</code></strong> : <span
class="inlinecode"><a class="idref" href="EraVM.sem.PrecompileCall.html#PrecompileCallDefinition"><span
class="id" title="section">PrecompileCallDefinition</span></a></span> :
call an extension of VM specific to currently executing system
contract.</p></li>
<li><p><strong><code>Context</code></strong> : <span
class="inlinecode"><span class="id"
title="var">ContextDefinition</span></span> : access some parts of VM
state such as currently executed contract or stack pointer.</p></li>
</ul></li>
</ul></li>
<li><p><strong>ABI</strong> (memory layouts of compound data structures
serialized to 256-bit words.)</p>
<ul>
<li><span class="inlinecode"><span class="id"
title="library">Coder</span></span> : general definitions of encoding,
decoding, composition and required properties.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.NearCallABI.html#NearCallABI"><span
class="id" title="section">NearCallABI</span></a></span></li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.FatPointerABI.html#FatPointerABI"><span
class="id" title="section">FatPointerABI</span></a></span></li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.FarCallABI.html#FarCallABI"><span
class="id" title="section">FarCallABI</span></a></span></li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.FarRetABI.html#FarRetABI"><span
class="id" title="section">FarRetABI</span></a></span></li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.MetaParametersABI.html#MetaParametersABI"><span
class="id" title="section">MetaParametersABI</span></a></span> : layout
of result of <span class="inlinecode"><span class="id"
title="var">ContextMeta</span></span>.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.ABI.PrecompileParametersABI.html#PrecompileParametersABI"><span
class="id" title="section">PrecompileParametersABI</span></a></span> :
layout of result of <span class="inlinecode"><span class="id"
title="var">ContextMeta</span></span>.</li>
</ul></li>
<li><p><strong>Instruction encoding</strong></p>
<ul>
<li><span
class="inlinecode"><a class="idref" href="EraVM.encoding.EncodingUtils.html#EncodingTools"><span
class="id" title="section">EncodingTools</span></a></span> : binary
encoding of different parts of instruction layout.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.encoding.GeneratedEncodeOpcode.html#encode_opcode"><span
class="id" title="definition">encode_opcode</span></a></span> : encoding
source/destination, addressing modes, and all modifiers as a single
11-bit opcode value.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.encoding.Encoder.html#MachEncoder"><span
class="id" title="section">MachEncoder</span></a></span> : the main
assembly instruction encoder definition.</li>
</ul></li>
<li><p><strong>Elements of protocol</strong></p>
<ul>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Bootloader.html#Bootloader"><span
class="id" title="section">Bootloader</span></a></span> : a system
contract in charge of block construction.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Precompiles.html#Precompiles"><span
class="id" title="section">Precompiles</span></a></span> : extensions of
virtual machine.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.VersionedHash.html#VersionedHash"><span
class="id" title="section">VersionedHash</span></a></span> : used to
fetch the contract code.</li>
<li><span
class="inlinecode"><a class="idref" href="EraVM.Decommitter.html#Decommitter"><span
class="id" title="section">Decommitter</span></a></span></li>
</ul></li>
</ul>
</div>
<div class="code">
<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>