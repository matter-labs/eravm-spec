<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>EraVM.KernelMode</title>

  <script defer=""
  src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" />
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library EraVM.KernelMode</h1>

<div class="code">
<span class="id" title="keyword">Require</span> <a class="idref" href="EraVM.isa.CoreSet.html#"><span class="id" title="library">isa.CoreSet</span></a> <a class="idref" href="EraVM.memory.Depot.html#"><span class="id" title="library">memory.Depot</span></a>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="EraVM.isa.CoreSet.html#"><span class="id" title="module">CoreSet</span></a> <a class="idref" href="EraVM.TransientMemory.html#"><span class="id" title="module">TransientMemory</span></a> <a class="idref" href="EraVM.memory.Depot.html#"><span class="id" title="module">memory.Depot</span></a>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <a id="KernelMode" class="idref" href="#KernelMode"><span class="id" title="section">KernelMode</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.ZArith.ZArith.html#"><span class="id" title="module">ZArith</span></a> <a class="idref" href="EraVM.Arith.html#"><span class="id" title="module">Arith</span></a> <span class="id" title="module">spec</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">ZMod_scope</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> {<a id="descr:1" class="idref" href="#descr:1"><span class="id" title="binder">descr</span></a>: <a class="idref" href="EraVM.isa.CoreSet.html#descr"><span class="id" title="record">CoreSet.descr</span></a>}.<br/>
</div>

<div class="doc"><h1 id="kernel-mode">Kernel Mode</h1>
<p>EraVM operates either in <strong>kernel</strong> or in <strong>user
mode</strong>. Some instructions (see <span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#requires_kernel"><span
class="id" title="definition">requires_kernel</span></a></span> are only
allowed in kernel mode; executing them in user mode results in
panic.</p>
<p>Current mode is determined by the address of the currently executed
contract <span class="math inline">C</span>:</p>
<ul>
<li>if <span class="math inline">C &lt;</span> <span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#KERNEL_MODE_MAXADDR_LIMIT"><span
class="id"
title="definition">KERNEL_MODE_MAXADDR_LIMIT</span></a></span>, EraVM is
in kernel mode;</li>
<li>otherwise, EraVM is in user mode.</li>
</ul>
</div>
<div class="code">
<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="KERNEL_MODE_MAXADDR_LIMIT" class="idref" href="#KERNEL_MODE_MAXADDR_LIMIT"><span class="id" title="definition">KERNEL_MODE_MAXADDR_LIMIT</span></a> : <a class="idref" href="EraVM.memory.Depot.html#contract_address"><span class="id" title="definition">contract_address</span></a> := <span class="id" title="definition">fromZ</span> (2<a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.ZArith.BinInt.html#14ef112b66e341f773bd1e9d05816f43"><span class="id" title="notation">^</span></a>16).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="addr_is_kernel" class="idref" href="#addr_is_kernel"><span class="id" title="definition">addr_is_kernel</span></a> (<a id="addr:2" class="idref" href="#addr:2"><span class="id" title="binder">addr</span></a>:<a class="idref" href="EraVM.memory.Depot.html#contract_address"><span class="id" title="definition">contract_address</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="EraVM.KernelMode.html#addr:2"><span class="id" title="variable">addr</span></a> <a class="idref" href="EraVM.Arith.html#::ZMod_scope:x_'<'_x"><span class="id" title="notation"><</span></a> <a class="idref" href="EraVM.KernelMode.html#KERNEL_MODE_MAXADDR_LIMIT"><span class="id" title="definition">KERNEL_MODE_MAXADDR_LIMIT</span></a>.<br/>

<br/>
</div>

<div class="doc"><p>Current contract’s address can be obtained from the active external
frame in <span
class="inlinecode"><a class="idref" href="EraVM.CallStack.html#callstack"><span
class="id" title="inductive">callstack</span></a></span>. Topmost
external frame (active frame) is obtained through <span
class="inlinecode"><a class="idref" href="EraVM.CallStack.html#active_extframe"><span
class="id" title="definition">active_extframe</span></a></span>, it
contains the current contract’s address in its field <span
class="inlinecode"><a class="idref" href="EraVM.CallStack.html#ecf_this_address"><span
class="id" title="projection">ecf_this_address</span></a></span>.</p>
<p>The list of instructions requiring kernel mode is encoded by the
definition <span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#requires_kernel"><span
class="id" title="definition">requires_kernel</span></a></span>. If
<span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#requires_kernel"><span
class="id" title="definition">requires_kernel</span></a></span> <span
class="inlinecode"><span class="id" title="var">ins</span></span> <span
class="inlinecode">==</span> <span
class="inlinecode"><a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#true"><span
class="id" title="constructor">true</span></a></span>, the instruction
<span class="inlinecode"><span class="id" title="var">ins</span></span>
is only allowed in kernel mode.</p>
</div>
<div class="code">
<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="requires_kernel" class="idref" href="#requires_kernel"><span class="id" title="definition">requires_kernel</span></a> (<a id="ins:3" class="idref" href="#ins:3"><span class="id" title="binder">ins</span></a>: @<a class="idref" href="EraVM.isa.CoreSet.html#instruction"><span class="id" title="inductive">instruction</span></a> <a class="idref" href="EraVM.KernelMode.html#KernelMode.descr"><span class="id" title="variable">descr</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="EraVM.KernelMode.html#ins:3"><span class="id" title="variable">ins</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpMimicCall"><span class="id" title="constructor">OpMimicCall</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpContextSetContextU128"><span class="id" title="constructor">OpContextSetContextU128</span></a> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpContextSetErgsPerPubdataByte"><span class="id" title="constructor">OpContextSetErgsPerPubdataByte</span></a> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpContextIncrementTxNumber"><span class="id" title="constructor">OpContextIncrementTxNumber</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpEvent"><span class="id" title="constructor">OpEvent</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpToL1Message"><span class="id" title="constructor">OpToL1Message</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="EraVM.isa.CoreSet.html#OpPrecompileCall"><span class="id" title="constructor">OpPrecompileCall</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;⇒ <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc"><p>Function <span
class="inlinecode"><a class="idref" href="EraVM.KernelMode.html#check_requires_kernel"><span
class="id" title="definition">check_requires_kernel</span></a></span>
returns <span
class="inlinecode"><a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#false"><span
class="id" title="constructor">false</span></a></span> if:</p>
<ul>
<li>an instruction <span class="inlinecode"><span class="id"
title="var">ins</span></span> requires kernel mode, and</li>
<li>VM is not in kernel mode, as indicated by <span
class="inlinecode"><span class="id"
title="var">in_kernel</span></span>.</li>
</ul>
</div>
<div class="code">
<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="check_requires_kernel" class="idref" href="#check_requires_kernel"><span class="id" title="definition">check_requires_kernel</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a id="ins:5" class="idref" href="#ins:5"><span class="id" title="binder">ins</span></a>: @<a class="idref" href="EraVM.isa.CoreSet.html#instruction"><span class="id" title="inductive">instruction</span></a> <a class="idref" href="EraVM.KernelMode.html#KernelMode.descr"><span class="id" title="variable">descr</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a id="in_kernel:6" class="idref" href="#in_kernel:6"><span class="id" title="binder">in_kernel</span></a>: <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>) : <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <a class="idref" href="EraVM.KernelMode.html#in_kernel:6"><span class="id" title="variable">in_kernel</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18+alpha/stdlib//Coq.Init.Datatypes.html#081ff67d3116402bb680e8692aa39185"><span class="id" title="notation">||</span></a> <a class="idref" href="EraVM.KernelMode.html#in_kernel:6"><span class="id" title="variable">in_kernel</span></a>.<br/>

<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="EraVM.KernelMode.html#KernelMode"><span class="id" title="section">KernelMode</span></a>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>